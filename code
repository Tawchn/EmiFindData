import customtkinter as ctk
import pandas as pd
import numpy as np
from PIL import Image
from tkinter import filedialog, messagebox
import os


class ProfilerLogic:
    @staticmethod
    def get_stats(series):
        nulls = series.isnull().sum()
        unique_pct = (series.nunique() / len(series)) * 100 if len(series) > 0 else 0
        outliers = 0
        if pd.api.types.is_numeric_dtype(series) and not series.empty:
            q1, q3 = series.quantile(0.25), series.quantile(0.75)
            iqr = q3 - q1
            outliers = ((series < (q1 - 1.5 * iqr)) | (series > (q3 + 1.5 * iqr))).sum()
        is_key = "üîë Unique ID" if (series.is_unique and nulls == 0) else "Standard"
        return nulls, outliers, is_key, unique_pct


class EmiFindData(ctk.CTk):
    def __init__(self):
        super().__init__()
        self.title("EmiFindData Professional | Desktop")
        self.geometry("1400x950")
        ctk.set_appearance_mode("dark")
        self.datasets = {}

        # SIDEBAR
        self.sidebar = ctk.CTkFrame(self, width=300, corner_radius=0, fg_color="#0a0a0a")
        self.sidebar.pack(side="left", fill="y")

        # LOGO
        try:
            logo_img = ctk.CTkImage(Image.open("IMG_8009.jpeg"), size=(200, 280))
            ctk.CTkLabel(self.sidebar, image=logo_img, text="").pack(pady=20)
        except:
            ctk.CTkLabel(self.sidebar, text="EmiFindData", font=("Impact", 32)).pack(pady=20)

        # ADD DATA BUTTON
        try:
            plus_img = ctk.CTkImage(Image.open("IMG_8017.jpeg"), size=(60, 80))
            ctk.CTkButton(self.sidebar, image=plus_img, text="", fg_color="transparent",
                          hover_color="#1a1a1a", command=self.load_files).pack()
            ctk.CTkLabel(self.sidebar, text="Import Data", font=("Arial", 12)).pack()
        except:
            ctk.CTkButton(self.sidebar, text="+ Add Data", command=self.load_files).pack(pady=10)

        # DATASET LIST SECTION
        try:
            f_img = ctk.CTkImage(Image.open("IMG_8015.jpeg"), size=(50, 70))
            ctk.CTkLabel(self.sidebar, image=f_img, text="").pack(pady=(30, 0))
        except:
            pass
        ctk.CTkLabel(self.sidebar, text="Active Datasets", font=("Arial", 14, "bold")).pack()

        self.file_list = ctk.CTkScrollableFrame(self.sidebar, fg_color="transparent")
        self.file_list.pack(fill="both", expand=True, padx=10, pady=10)

        # MAIN TABS
        self.tabs = ctk.CTkTabview(self, corner_radius=15)
        self.tabs.pack(side="right", fill="both", expand=True, padx=20, pady=20)
        self.tab_prof = self.tabs.add("üî¨ Data Profiler")
        self.tab_view = self.tabs.add("üóÇÔ∏è Table Browser")

    def load_files(self):
        paths = filedialog.askopenfilenames(filetypes=[("Data", "*.csv *.xlsx")])
        for path in paths:
            name = os.path.basename(path)
            try:
                self.datasets[name] = pd.read_csv(path) if path.endswith('.csv') else pd.read_excel(path)
            except Exception as e:
                messagebox.showerror("Error", f"Failed to load {name}: {e}")
        self.refresh_sidebar()

    def refresh_sidebar(self):
        """Redraws the sidebar and clears the main screen if no data exists."""
        for w in self.file_list.winfo_children(): w.destroy()

        if not self.datasets:
            self.clear_main_screen()
            return

        for name in self.datasets.keys():
            row = ctk.CTkFrame(self.file_list, fg_color="#1a1a1a", corner_radius=8)
            row.pack(fill="x", pady=3)
            ctk.CTkButton(row, text=name[:15], fg_color="transparent", anchor="w",
                          command=lambda n=name: self.run_profiler(n)).pack(side="left", padx=5, fill="x", expand=True)
            ctk.CTkButton(row, text="üóëÔ∏è", width=30, fg_color="transparent", text_color="red",
                          command=lambda n=name: self.delete_dataset(n)).pack(side="right", padx=5)

    def delete_dataset(self, name):
        """Removes the dataset and triggers a screen refresh."""
        if messagebox.askyesno("Confirm", f"Remove {name} from project?"):
            del self.datasets[name]
            self.refresh_sidebar()

    def clear_main_screen(self):
        """Wipes the profiling and table tabs clean."""
        for w in self.tab_prof.winfo_children(): w.destroy()
        for w in self.tab_view.winfo_children(): w.destroy()
        ctk.CTkLabel(self.tab_prof, text="No Data Loaded", font=("Arial", 16)).pack(pady=100)

    def run_profiler(self, name):
        df = self.datasets[name]
        for w in self.tab_prof.winfo_children(): w.destroy()
        scroll = ctk.CTkScrollableFrame(self.tab_prof, fg_color="transparent")
        scroll.pack(fill="both", expand=True)

        ctk.CTkLabel(scroll, text=f"Analysis: {name}", font=("Arial", 22, "bold")).pack(pady=15)

        for col in df.columns:
            nulls, outliers, key_status, unique = ProfilerLogic.get_stats(df[col])
            card = ctk.CTkFrame(scroll, corner_radius=10, border_width=1, border_color="#333")
            card.pack(fill="x", pady=5, padx=10)

            msg = (f"COLUMN: {col}\n‚Ä¢ Type: {df[col].dtype} | Missing: {nulls}\n"
                   f"‚Ä¢ Outliers: {outliers} | Uniqueness: {unique:.1f}%\n‚Ä¢ Status: {key_status}")
            ctk.CTkLabel(card, text=msg, justify="left", font=("Consolas", 13)).pack(padx=20, pady=12, anchor="w")

        # Refresh Table View
        for w in self.tab_view.winfo_children(): w.destroy()
        tb = ctk.CTkTextbox(self.tab_view, font=("Consolas", 12))
        tb.pack(fill="both", expand=True)
        tb.insert("0.0", df.head(100).to_string())


if __name__ == "__main__":
    app = EmiFindData()
    app.mainloop()
